#include "config-builder.h"

#include <aitown/error_codes.h>
#include <aitown/dbg_assert.h>
#include <aitown/cfgpath.h>
#include <aitown/dir_utils.h>
#include <aitown/config.h>


#include <stdio.h>


#define KYOTO_NAME  "buildin-kyoto"
#define TOKYO_NAME  "buildin-tokyo"
#define MYSQL_NAME  "buildin-mysql"

#define IF_FLAG_IS_SET(__f__)   if ((flags & __f__) == __f__)

const char * write_config_file(const char * name, int flags) {

    // het full file path
    int sz_p = strlen (OS_TEMPORARY_DIR);
    int sz_f = strlen (name) + 32;
    char * ret = (char*)malloc (sz_p+sz_f);
    DBG_ASSERT (ret != NULL);

    sprintf (ret, "%s/%s.ini", OS_TEMPORARY_DIR, name);

    FILE * f = fopen (ret, "w");
    DBG_ASSERT (f != NULL);


    fprintf (f,
             ";\n"
             "; test config file generated by write_config_file()\n"
             "; function in tests/config-builder.c\n"
             ";\n"
             "\n");


    IF_FLAG_IS_SET(CFGTEST_DRIVERS) {
        fprintf (f,
                 "[drivers]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DRIVERS_KYOTO) {
        fprintf (f,
                 "[drivers/" KYOTO_NAME "]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DRIVERS_TOKYO) {
        fprintf (f,
                 "[drivers/" TOKYO_NAME "]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DRIVERS_MYSQL) {
        fprintf (f,
                 "[drivers/" MYSQL_NAME "]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DATABASES) {
        fprintf (f,
                 "[databases]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DATABASE_1) {
        fprintf (f,
                 "[databases/test1]\n"
                 "  \n"
                 "  driver = " KYOTO_NAME "\n"
                 "  path_hint = %s\n"
                 "  key_len = 8\n"
                 "  value_len = \n"
                 "\n"
                 , OS_TEMPORARY_DIR);
    }

    IF_FLAG_IS_SET(CFGTEST_DATABASE_2) {
        fprintf (f,
                 "[databases/test2]\n"
                 "  \n"
                 "  driver = " TOKYO_NAME "\n"
                 "  path_hint = %s\n"
                 "  key_len = 8\n"
                 "  value_len = \n"
                 "\n"
                 , OS_TEMPORARY_DIR);
    }

    IF_FLAG_IS_SET(CFGTEST_DATABASE_ID) {
        fprintf (f,
                 "[databases/iddatabase]\n"
                 "  \n"
                 "  driver = " KYOTO_NAME "\n"
                 "  path_hint = %s\n"
                 "  key_len = 8\n"
                 "  value_len = \n"
                 "\n"
                 "[dstorage]\n"
                 "  id_database = \"iddatabase\"\n"
                 "\n"
                 , OS_TEMPORARY_DIR);
    }

    IF_FLAG_IS_SET(CFGTEST_DSTORAGE) {
        fprintf (f,
                 "[dstorage]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DSTORAGE_CTRL) {
        fprintf (f,
                 "[dstorage/controllers]\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DSTORAGE_CTRL_1) {
        fprintf (f,
                 "[databases/ctrl1]\n"
                 "  driver = " KYOTO_NAME "\n"
                 "  path_hint = %s\n"
                 "  key_len = 8\n"
                 "  value_len = \n"
                 "\n"
                 "[dstorage/controllers/0]\n"
                 "  status = TEMP_ERR\n"
                 "  performance = 30\n"
                 "  database = \"ctrl1\"\n"
                 "\n", OS_TEMPORARY_DIR);
    }

    IF_FLAG_IS_SET(CFGTEST_DSTORAGE_HANDLES) {
        fprintf (f,
                 "[dstorage/handlers]\n"
                 "  database = \"iddatabase\"\n"
                 "  next_id = 1\n"
                 "  handle_max = 1024\n"
                 "  free_max = 1024\n"
                 "  cache_max = 512\n"
                 "\n");
    }

    IF_FLAG_IS_SET(CFGTEST_DEJAVU) {
        fprintf (f,
                 "[dejavu]\n"
                 "  input_cols = 16\n"
                 "  input_rows = 16\n"
                 "  ar_cols = 16\n"
                 "  ar_rows = 16\n"
                 "\n"
                "[databases/dejavu_level1]\n"
                "  \n"
                "  driver = " KYOTO_NAME "\n"
                "  path_hint = %s\n"
                "  key_len = 8\n"
                "  value_len = \n"
                "\n", OS_TEMPORARY_DIR);
    }




    fclose (f);

    return ret;
}
